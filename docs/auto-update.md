# Auto-Update System

Zinnia includes an auto-update system that checks for new versions on startup and allows users to update with a single click.

## How It Works

1. **On Startup**: The app silently checks for updates from GitHub releases
2. **Update Available**: A persistent toast appears at the top of the window
3. **User Action**: User clicks "Update & Restart" to download and install
4. **Installation**: Update downloads, installs, and restarts the app

## Architecture

### Frontend Components

- **`utils/updater.ts`**: Core update checking and installation logic
  - `checkForUpdates()`: Checks GitHub releases endpoint
  - `downloadAndInstallUpdate()`: Downloads and installs update with progress tracking
  - `restartApp()`: Relaunches the app after installation

- **`components/UpdateToast.tsx`**: Persistent banner at top of app
  - Shows version number and release notes
  - "Update & Restart" button with progress indicator
  - Dismissible (user can choose to update later)

- **`App.tsx`**: Integration point
  - Runs update check on mount
  - Manages update state
  - Renders UpdateToast when update available

### Backend

- **Tauri Plugins**: 
  - `tauri-plugin-updater`: Core update functionality
  - `tauri-plugin-dialog`: User prompts (if needed)
  - `tauri-plugin-process`: App restart after update

### Update Endpoint

Updates are served from GitHub releases:
```
https://github.com/korbindeman/zinnia/releases/latest/download/latest.json
```

This JSON file is automatically generated by the GitHub Actions workflow and contains:
- Version number
- Release notes
- Download URLs for each platform
- Cryptographic signatures

## Creating a Release

### 1. Update Version Number

Edit `crates/frontend/src-tauri/tauri.conf.json`:
```json
{
  "version": "0.3.0"
}
```

### 2. Commit and Tag

```bash
git add crates/frontend/src-tauri/tauri.conf.json
git commit -m "Bump version to 0.3.0"
git tag v0.3.0
git push origin main
git push origin v0.3.0
```

### 3. GitHub Actions Builds

The workflow at `.github/workflows/release.yml` automatically:
- Builds for macOS (Intel + Apple Silicon)
- Signs the updates with your Tauri signing key
- Creates a draft release with all artifacts
- Generates `latest.json` update manifest

### 4. Publish Release

1. Go to https://github.com/korbindeman/zinnia/releases
2. Find the draft release
3. Review the artifacts (should include `.app.tar.gz` and `.sig` files)
4. Edit release notes if desired
5. Click "Publish release"

Users running older versions will now see the update toast on next launch.

## GitHub Secrets Setup

The following secrets must be configured in your GitHub repository settings:

### Required for Updates

1. **`TAURI_SIGNING_PRIVATE_KEY`**
   - Content of `~/.tauri/zinnia.key`
   - Used to sign updates so users can verify authenticity
   - **Keep this secret!** If lost, existing users won't be able to update

2. **`TAURI_SIGNING_PRIVATE_KEY_PASSWORD`** (if you set one)
   - Password used when generating the key
   - Leave empty if you didn't set a password

### To Add Secrets:

1. Go to: https://github.com/korbindeman/zinnia/settings/secrets/actions
2. Click "New repository secret"
3. Add each secret:
   - For `TAURI_SIGNING_PRIVATE_KEY`: `cat ~/.tauri/zinnia.key | pbcopy` and paste
   - For `TAURI_SIGNING_PRIVATE_KEY_PASSWORD`: Enter your password or leave empty

### Optional: Apple Code Signing (for distribution)

When you're ready to properly sign the macOS app (requires paid Apple Developer account):

1. **`APPLE_CERTIFICATE`**: Base64-encoded .p12 certificate
2. **`APPLE_CERTIFICATE_PASSWORD`**: Certificate password
3. **`APPLE_SIGNING_IDENTITY`**: e.g., "Developer ID Application: Your Name (TEAMID)"
4. **`APPLE_ID`**: Your Apple ID email
5. **`APPLE_PASSWORD`**: App-specific password (not your main password)
6. **`APPLE_TEAM_ID`**: Your Apple Developer team ID

Uncomment these lines in `.github/workflows/release.yml` when ready.

## Testing the Update Flow

### Local Testing

1. Build and install version 0.2.0 locally
2. Create a test release on GitHub with version 0.3.0
3. Open the 0.2.0 app
4. Update toast should appear
5. Click "Update & Restart"
6. App should download, install, and relaunch as 0.3.0

### Debug Mode

The updater is disabled in development mode. To test locally:
- Build a production version: `npm run tauri build`
- Install the built app from `src-tauri/target/release/bundle/`

## Security

### Update Signing

Every update is cryptographically signed with your private key. The app verifies signatures using the public key in `tauri.conf.json` before installing. This prevents:
- Malicious update injection
- Man-in-the-middle attacks
- Tampered releases

**Important**: Never commit your private key (`~/.tauri/zinnia.key`) to git. Keep it secure and backed up.

### HTTPS Required

Updates are served over HTTPS (GitHub releases). In development builds, the updater may allow HTTP for testing, but production builds enforce HTTPS.

## Troubleshooting

### Update Check Fails

- Check that GitHub release is published (not draft)
- Verify `latest.json` exists at the endpoint
- Check browser console for errors

### Update Download Fails

- Ensure `.app.tar.gz` and `.sig` files are in the release
- Verify file URLs are correct in `latest.json`
- Check network connectivity

### Signature Verification Fails

- Public key in `tauri.conf.json` must match private key used to sign
- Ensure `TAURI_SIGNING_PRIVATE_KEY` secret is correct
- Verify `.sig` file was generated during build

### App Won't Launch After Update (macOS)

Without Apple code signing, macOS may block the app:
- Right-click app → Open → confirm you want to open it
- Or: System Settings → Privacy & Security → allow the app
- For production, get an Apple Developer account and enable code signing

## Configuration

### Update Endpoint

Edit `crates/frontend/src-tauri/tauri.conf.json`:
```json
{
  "plugins": {
    "updater": {
      "endpoints": [
        "https://your-custom-endpoint.com/latest.json"
      ]
    }
  }
}
```

### Update Check Timing

Currently checks on app startup. To add manual checks:

```typescript
import { checkForUpdates } from "./utils/updater";

// In a menu handler or button click
const handleCheckForUpdates = async () => {
  const update = await checkForUpdates();
  if (update) {
    setUpdateInfo(update);
  } else {
    // Show "You're up to date" message
  }
};
```

## Architecture Decisions

### Why GitHub Releases?

- Free hosting
- Automatic `latest.json` generation via `tauri-action`
- No server maintenance required
- Works well for open-source projects

### Why Persistent Toast?

- Non-intrusive (doesn't block user)
- Always visible (won't be missed)
- User controls when to update
- Clear action button

### Why Auto-Check on Startup?

- Ensures users are notified of updates promptly
- Doesn't interrupt workflow (happens before they start working)
- Only shows toast if update is actually available
- Users can dismiss and continue working

## Future Enhancements

Potential improvements for the update system:

1. **Menu Item**: Add "Check for Updates..." to app menu
2. **Release Notes**: Show formatted release notes in a modal
3. **Update Channels**: Support beta/stable channels
4. **Background Downloads**: Download updates in background, prompt when ready
5. **Automatic Updates**: Option to auto-update without prompting (with user consent)
